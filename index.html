<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Scanner Cripto Ultra Aprimorado com An√°lise Macro</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    tr[class^="score-"] { transition: background 0.5s; }
    tr.score-10 { background-color: #d9ead3; font-weight: bold; }
    tr.score-12 { background-color: #b6d7a8; font-weight: bold; }
    tr.score-14, tr.score-15 { background-color: #6aa84f; font-weight: bold; color: white; }
    .destaque { background-color: #ffd966 !important; color: #000; }
  </style>
</head>
<body>
  <h1>Scanner Cripto Ultra Aprimorado com An√°lise Macro</h1>
  <p>Detector de oportunidades com sinais t√©cnicos, contexto macro (Di√°rio, Semanal, Mensal) e stops inteligentes. Agora analisando TODAS as moedas da Binance.</p>
  <table id="tabela">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Pre√ßo</th>
        <th>Score</th>
        <th>Explica√ß√£o</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const TELEGRAM_TOKEN = '7149610493:AAE5SwHYZEWCikEPa2_gXnv5BkOkaE2NDpM';
    const TELEGRAM_CHAT_ID = '6656069569';
    const alertados = {};

    function calcularMedia(precos, periodo) {
      const slice = precos.slice(-periodo);
      return slice.reduce((a, b) => a + b, 0) / periodo;
    }

    function calcularRSI(precos) {
      if (precos.length < 15) return 50;
      let ganhos = 0, perdas = 0;
      for (let i = 1; i <= 14; i++) {
        const diff = precos[i] - precos[i - 1];
        if (diff >= 0) ganhos += diff;
        else perdas -= diff;
      }
      const rs = ganhos / (perdas || 1);
      return 100 - (100 / (1 + rs));
    }

    function calcularMACD(precos) {
      return calcularMedia(precos, 12) - calcularMedia(precos, 26);
    }

    function calcularADX_simples(precos) {
      const diffs = precos.slice(-14).map((v, i) => Math.abs(precos[i + 1] - v));
      return (diffs.reduce((a, b) => a + b, 0) / diffs.length) > 0.02 ? 25 : 10;
    }

    function calcularOBV(precos, volumes) {
      let obv = 0;
      for (let i = 1; i < precos.length; i++) {
        if (precos[i] > precos[i - 1]) obv += volumes[i];
        else if (precos[i] < precos[i - 1]) obv -= volumes[i];
      }
      return obv;
    }

    function ultimoFundo(precos) {
      return Math.min(...precos.slice(-10));
    }

    function ultimoTopo(precos) {
      return Math.max(...precos.slice(-10));
    }

    async function verificarMacro(symbol) {
      const timeframes = ['1d', '1w', '1M'];
      for (const tf of timeframes) {
        const klines = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${tf}&limit=30`).then(res => res.json());
        const prices = klines.map(k => parseFloat(k[4]));
        if (prices.length < 21) return false;
        const media = calcularMedia(prices, 21);
        const precoAtual = prices.at(-1);
        if (precoAtual < media) return false;
      }
      return true;
    }

    async function buscarMoedasBinance() {
      const tabela = document.querySelector('#tabela tbody');
      tabela.innerHTML = '';

      const exchangeInfo = await fetch('https://api.binance.com/api/v3/exchangeInfo').then(res => res.json());
      const usdtPairs = exchangeInfo.symbols.filter(s => s.symbol.endsWith('USDT') && s.status === 'TRADING');

      for (const pair of usdtPairs) {
        const symbol = pair.symbol;
        const baseAsset = pair.baseAsset;

        try {
          const macroOK = await verificarMacro(symbol);
          if (!macroOK) continue;

          const [ticker, klines] = await Promise.all([
            fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`).then(res => res.json()),
            fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=100`).then(res => res.json())
          ]);

          const prices = klines.map(k => parseFloat(k[4]));
          const volumes = klines.map(k => parseFloat(k[5]));
          if (prices.length < 30) continue;

          const sinais = [];
          let score = 0;

          if (calcularRSI(prices) < 35) { score += 2; sinais.push('RSI < 35'); }
          if (parseFloat(ticker.quoteVolume) > 1000000) { score++; sinais.push('Volume alto'); }
          if (calcularMACD(prices) > 0) { score += 2; sinais.push('MACD positivo'); }
          if (calcularADX_simples(prices) > 20) { score += 2; sinais.push('ADX > 20'); }
          if (calcularOBV(prices, volumes) > 0) { score += 2; sinais.push('OBV positivo'); }

          const precoAtual = prices.at(-1);
          const stop = ultimoFundo(prices).toFixed(4);
          const alvo = (ultimoTopo(prices) * 1.02).toFixed(4);

          if (score >= 10) {
            const linha = document.createElement('tr');
            linha.classList.add(`score-${Math.min(score, 15)}`);
            if (score >= 12) linha.classList.add('destaque');

            linha.innerHTML = `
              <td>${baseAsset} (${symbol})</td>
              <td>US$ ${precoAtual.toFixed(4)}</td>
              <td>${score}</td>
              <td>${sinais.join(', ')}</td>`;
            tabela.appendChild(linha);

            const id = symbol.toLowerCase();
            if (!alertados[id] || alertados[id] < score) {
              alertados[id] = score;
              const msg = `üöÄ *Oportunidade de Compra Detected!*
üìà *Moeda:* ${baseAsset} (${symbol})
üí∞ *Pre√ßo atual:* US$ ${precoAtual.toFixed(4)}
üî• *Score:* ${score}
üìä *Sinais:* ${sinais.join(', ')}
üéØ *Entrada sugerida:* US$ ${precoAtual.toFixed(4)}
üõë *Stop:* US$ ${stop}
üéØ *Alvo:* US$ ${alvo}`;
              fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: msg })
              });
            }
          }
        } catch (erro) {
          console.warn(`Erro com ${symbol}:`, erro.message);
        }
      }
    }

    buscarMoedasBinance();
    setInterval(buscarMoedasBinance, 90000);
  </script>
</body>
</html>